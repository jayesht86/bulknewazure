locals {
  # Convert ASG set(object) into a map
  asg_mapped = { 
    for asg in var.asg_config : asg.asg_name => {
      asg_name        = asg.asg_name
      asg_custom_tags = asg.asg_custom_tags != null ? asg.asg_custom_tags : {} # ✅ Handle `null`
      asg_association_nic_names = asg.asg_association_nic_names != null ? asg.asg_association_nic_names : [] # ✅ Handle `null`
    } 
  }

  # Flatten ASG-to-NIC associations for Terraform `for_each`
  asg_attachment = flatten([
    for asg in local.asg_mapped : [
      for nic in asg.asg_association_nic_names : { # ✅ This will no longer break if `null`
        nic_name = nic
        asg_name = asg.asg_name
      }
    ]
  ])

  # Convert ASG associations into a key-value map
  asg_attachment_map = { for attachment in local.asg_attachment : "${attachment.nic_name}-${attachment.asg_name}" => attachment }
}
