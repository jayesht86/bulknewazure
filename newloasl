nic_list = flatten([
    for vm in local.vm_list : concat(
      [{ vm_name = vm.name, nic_name = vm.linux_vm_default_nic.nic_name }],
      [for nic in vm.linux_vm_additional_nic : { vm_name = vm.name, nic_name = nic.nic_name }]
    )
  ])

  # Auto-generate ASG mappings per NIC dynamically
  asg_mapped = {
    for nic in local.nic_list : nic.nic_name => {
      asg_name        = format("%s-asg", nic.nic_name) # ✅ ASG Name based on NIC Name
      nic_name        = nic.nic_name
      asg_custom_tags = merge(var.tags, { "AutoGenerated" = "true" }) # ✅ Custom ASG tags
    }
  }

  # Flatten ASG-to-NIC associations for Terraform `for_each`
  asg_attachment = flatten([
    for asg in local.asg_mapped : [
      { nic_name = asg.nic_name, asg_name = asg.asg_name }
    ]
  ])

  # Convert ASG associations into a key-value map
  asg_attachment_map = {
    for attachment in local.asg_attachment :
      "${attachment.nic_name}-${attachment.asg_name}" => attachment
  }
}




module "network_asg" {
  source = "git::https://dev.azure.com/msci-otw/tech-iac/_git/terraform-azurerm-msci-network-asg?ref=0.3"

  for_each = local.asg_mapped

  asg_name              = each.value.asg_name
  subscription_id       = var.subscription_id
  resource_group_object = data.azurerm_resource_group.existing_rg
  tags                  = merge(each.value.asg_custom_tags, var.tags)
}



resource "azurerm_network_interface_application_security_group_association" "asg_association" {
  for_each = local.asg_attachment_map

  network_interface_id          = module.nic.nic_list[each.value.nic_name] # ✅ Ensures correct NIC mapping
  application_security_group_id = module.network_asg[each.value.asg_name].id
}


asg_config = [
  {
    asg_name                = "web-tier-asg"
    asg_custom_tags         = { "Environment" = "dev", "Owner" = "team-a" }
    asg_association_nic_names = ["vm1-primary-nic", "vm2-primary-nic"]
  },
  {
    asg_name                = "db-tier-asg"
    asg_custom_tags         = { "Environment" = "prod", "Owner" = "team-b" }
    asg_association_nic_names = ["vm3-primary-nic"]
  }
]
